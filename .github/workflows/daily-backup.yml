name: Daily CRM Backup

on:
  schedule:
    # Run every day at 03:00 UTC (06:00 Israel time)
    - cron: '0 3 * * *'
  workflow_dispatch:  # Allow manual trigger

env:
  CRM_URL: https://superb-transformation-production.up.railway.app
  CRON_SECRET: twenty2crm-backup-2024

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Trigger Backup Endpoint
        run: |
          echo "ğŸ”„ Triggering backup at $(date)"
          
          # Trigger the cron backup endpoint
          response=$(curl -s -w "%{http_code}" -o response.txt \
            "${{ env.CRM_URL }}/api/cron/backup?secret=${{ env.CRON_SECRET }}")
          
          echo "Response code: $response"
          cat response.txt
          
          if [ "$response" != "200" ]; then
            echo "âš ï¸ Backup endpoint returned non-200 status"
          fi

      - name: ğŸ’¾ Download Full Backup
        run: |
          echo "ğŸ“¥ Downloading full backup..."
          
          curl -s -o "backup-$(date +%Y-%m-%d).json" \
            "${{ env.CRM_URL }}/api/backup"
          
          # Show backup file size
          ls -lh backup-*.json
          
          # Count records
          if [ -f "backup-$(date +%Y-%m-%d).json" ]; then
            echo "âœ… Backup downloaded successfully"
            echo "ğŸ“Š File contents preview:"
            head -50 "backup-$(date +%Y-%m-%d).json"
          else
            echo "âŒ Failed to download backup"
            exit 1
          fi

      - name: ğŸ“¤ Upload Backup as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: crm-backup-${{ github.run_number }}-${{ github.run_id }}
          path: backup-*.json
          retention-days: 30
          if-no-files-found: warn

      - name: ğŸ”” Log Success
        if: success()
        run: |
          echo "âœ… Backup completed successfully at $(date)"
          echo "ğŸ“ Backup stored as artifact for 30 days"

      - name: âŒ Log Failure
        if: failure()
        run: |
          echo "âŒ Backup failed at $(date)"
          echo "Please check the CRM application logs"
